from flask import Flask, request
import requests
import openai

app = Flask(__name__)

# ▼ここにあなたのキーを貼る
LINE_ACCESS_TOKEN = "LINEのチャネルアクセストークン"
openai.api_key = "OpenAIのAPIキー"

@app.route("/webhook", methods=["POST"])
def webhook():
    data = request.json
    events = data.get("events", [])
    for event in events:
        if event.get("type") == "message":
            user_text = event["message"].get("text", "")
            reply_token = event["replyToken"]

            # ChatGPTへ投げる
            response = openai.ChatCompletion.create(
                model="gpt-4o",
                messages=[
                    {"role": "system", "content": "あなたはリユースショップの査定担当者です。簡潔に対応してください。"},
                    {"role": "user", "content": user_text}
                ]
            )
            answer = response["choices"][0]["message"]["content"]

            # LINEに返信
            requests.post(
                "https://api.line.me/v2/bot/message/reply",
                headers={"Authorization": f"Bearer {LINE_ACCESS_TOKEN}"},
                json={
                    "replyToken": reply_token,
                    "messages": [{"type": "text", "text": answer}]
                }
            )
    return "OK"

if __name__ == "__main__":
    app.run(port=5000)
